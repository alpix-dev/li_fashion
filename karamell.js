var promocoes_zip = [
    //SP
    {
      cep_ini : 01000000,
      cep_fim : 19999999,
      msg : "<b>Estado de SP</b></br>- 25% de desconto no frete, em compras acima de R$ 119,00<br>- 50% de desconto no frete, em compras acima de R$ 249,00<br>- 100% de desconto no frete / Frete Gr√°tis em compras acima de R$ 389,00"
    },
    //DF, ES, GO, MG, MS, PR, RJ, RS, SC:
    {
        cep_ini : 70000000,
        cep_fim : 73699999,
        msg : "<b>Estado de DF</b></br>- 25% de desconto no frete, em compras acima de R$ 249,00<br>- 50% de desconto no frete, em compras acima de R$ 399,00"
    },
    {
        cep_ini : 29000000,
        cep_fim : 29999999,
        msg : "<b>Estado de ES</b></br>- 25% de desconto no frete, em compras acima de R$ 249,00<br>- 50% de desconto no frete, em compras acima de R$ 399,00"
    },
    {
        cep_ini : 72800000,
        cep_fim : 76799999,
        msg : "<b>Estado de GO</b></br>- 25% de desconto no frete, em compras acima de R$ 249,00<br>- 50% de desconto no frete, em compras acima de R$ 399,00"
    },
    {
        cep_ini : 88000000,
        cep_fim : 89999999,
        msg : "<b>Estado de SC</b></br>- 25% de desconto no frete, em compras acima de R$ 249,00<br>- 50% de desconto no frete, em compras acima de R$ 399,00"
    },
    {
        cep_ini : 30000000,
        cep_fim : 39999999,
        msg : "<b>Estado de MG</b></br>- 25% de desconto no frete, em compras acima de R$ 249,00<br>- 50% de desconto no frete, em compras acima de R$ 399,00"
    },
    {
        cep_ini : 79000000,
        cep_fim : 79999999,
        msg : "<b>Estado de MS</b></br>- 25% de desconto no frete, em compras acima de R$ 249,00<br>- 50% de desconto no frete, em compras acima de R$ 399,00"
    },
    {
        cep_ini : 80000000,
        cep_fim : 87999999,
        msg : "<b>Estado de PR</b></br>- 25% de desconto no frete, em compras acima de R$ 249,00<br>- 50% de desconto no frete, em compras acima de R$ 399,00"
    },
    {
        cep_ini : 20000000,
        cep_fim : 28999999,
        msg : "<b>Estado de RJ</b></br>- 25% de desconto no frete, em compras acima de R$ 249,00<br>- 50% de desconto no frete, em compras acima de R$ 399,00"
    },
    {
        cep_ini : 90000000,
        cep_fim : 99999999,
        msg : "<b>Estado de RS</b></br>- 25% de desconto no frete, em compras acima de R$ 249,00<br>- 50% de desconto no frete, em compras acima de R$ 399,00"
    },
    {
        cep_ini : 88000000,
        cep_fim : 89999999,
        msg : "<b>Estado de SC</b></br>- 25% de desconto no frete, em compras acima de R$ 249,00<br>- 50% de desconto no frete, em compras acima de R$ 399,00"
    },    
    //GRUPO ESTADOS: BA, MT, CE, PA, PE, TO
    {
        cep_ini : 40000000,
        cep_fim : 48999999,
        msg : "<b>Estado de BA</b></br>- 25% de desconto no frete, em compras acima de R$ 349,00<br>- 50% de desconto no frete, em compras acima de R$ 599,00"
    },  
    {
        cep_ini : 78000000,
        cep_fim : 78899999,
        msg : "<b>Estado de MT</b></br>- 25% de desconto no frete, em compras acima de R$ 349,00<br>- 50% de desconto no frete, em compras acima de R$ 599,00"
    }, 
    {
        cep_ini : 60000000,
        cep_fim : 63999999,
        msg : "<b>Estado de CE</b></br>- 25% de desconto no frete, em compras acima de R$ 349,00<br>- 50% de desconto no frete, em compras acima de R$ 599,00"
    }, 
    {
        cep_ini : 66000000,
        cep_fim : 68899999,
        msg : "<b>Estado de PA</b></br>- 25% de desconto no frete, em compras acima de R$ 349,00<br>- 50% de desconto no frete, em compras acima de R$ 599,00"
    }, 
    {
        cep_ini : 50000000,
        cep_fim : 56999999,
        msg : "<b>Estado de PE</b></br>- 25% de desconto no frete, em compras acima de R$ 349,00<br>- 50% de desconto no frete, em compras acima de R$ 599,00"
    }, 
    {
        cep_ini : 77000000,
        cep_fim : 77995999,
        msg : "<b>Estado de TO</b></br>- 25% de desconto no frete, em compras acima de R$ 349,00<br>- 50% de desconto no frete, em compras acima de R$ 599,00"
    }, 
    //GRUPO ESTADOS: AC, AL, AM, AP, MA, PB, PI, RN, RO, RR, SE
    {
        cep_ini : 69900000,
        cep_fim : 69999999,
        msg : "<b>Estado de AC</b></br>- 25% de desconto no frete, em compras acima de R$ 599,00"
    }, 
    {
        cep_ini : 57000000,
        cep_fim : 57999999,
        msg : "<b>Estado de AL</b></br>- 25% de desconto no frete, em compras acima de R$ 599,00"
    }, 
    {
        cep_ini : 69400000,
        cep_fim : 69899999,
        msg : "<b>Estado de AM</b></br>- 25% de desconto no frete, em compras acima de R$ 599,00"
    }, 
    {
        cep_ini : 68900000,
        cep_fim : 68999999,
        msg : "<b>Estado de AP</b></br>- 25% de desconto no frete, em compras acima de R$ 599,00"
    }, 
    {
        cep_ini : 65000000,
        cep_fim : 65999999,
        msg : "<b>Estado de MA</b></br>- 25% de desconto no frete, em compras acima de R$ 599,00"
    }, 
    {
        cep_ini : 58000000,
        cep_fim : 58999999,
        msg : "<b>Estado de PB</b></br>- 25% de desconto no frete, em compras acima de R$ 599,00"
    }, 
    {
        cep_ini : 64000000,
        cep_fim : 64999999,
        msg : "<b>Estado de PI</b></br>- 25% de desconto no frete, em compras acima de R$ 599,00"
    }, 
    {
        cep_ini : 59000000,
        cep_fim : 59999999,
        msg : "<b>Estado de RN</b></br>- 25% de desconto no frete, em compras acima de R$ 599,00"
    }, 
    {
        cep_ini : 78900000,
        cep_fim : 78999999,
        msg : "<b>Estado de RO</b></br>- 25% de desconto no frete, em compras acima de R$ 599,00"
    }, 
    {
        cep_ini : 69300000,
        cep_fim : 69389999,
        msg : "<b>Estado de RR</b></br>- 25% de desconto no frete, em compras acima de R$ 599,00"
    }, 
    {
        cep_ini : 49000000,
        cep_fim : 49999999,
        msg : "<b>Estado de SE</b></br>- 25% de desconto no frete, em compras acima de R$ 599,00"
    }, 

];
if($('[name="zipcode"]').length > 0 && $('.page--product').length > 0){
    $(document).ajaxComplete(function(event, xhr, settings) {
        if(settings.url.split('?')[0] === "https://www.karamellstore.com.br/action/product-shipping/get"){
            var apx_clientZip = parseInt($('[name="zipcode"]').val().replace('-',''));
            if($('#apx_avisoZip').length == 0){
                $('.product-shipping-modal').prepend('<div id="apx_avisoZip"></div>');                
            }else{
                $('#apx_avisoZip').empty();
            }
            $.each(promocoes_zip, function(k, item){
                if(apx_clientZip >= item.cep_ini && apx_clientZip <= item.cep_fim){
                    $('<p>'+ item.msg +'</p>').appendTo('#apx_avisoZip');
                }
            });
        }
    });
}
if($('[name="zipcode"]').length > 0 && $('.page-cart.has-items').length > 0){
    var apx_clientZip = parseInt($('[name="zipcode"]').val().replace('-',''));
    $.each(promocoes_zip, function(k, item){
        if(apx_clientZip >= item.cep_ini && apx_clientZip <= item.cep_fim){
            $('<p style="line-height: 24px;display: block;font-size: 12px;margin:15px 0 0 0">'+ item.msg +'</p>').insertBefore('.shipping-result');
        }
        console.log(item);
    });    
}
if($('.collection .product-card').length > 0){
    if (window.location.href.indexOf("page=") > -1) {
        window.location = window.location.pathname;
    }
    var apx_pages = [];
    $('.change-page[name="page"]').first().find('option').each(function(){
        apx_pages.push($(this).attr('value'));                  
    });
    apx_pages.shift();          
    if(apx_pages.length > 0){
        $('.order-1 > section > .container-fluid > .row:nth-child(2)').after('<div id="apx_loading" data-loading="false" class="product-action-buy-loader" style="display: block;position: relative;width: 40px;margin: 40px auto 0 auto;top: auto;left: auto;text-align: center;transform: scale(1.5);"><div class="loader"></div></div>')
    }

    $(window).on('scroll', function(){
        if(checkVisible('.order-1 > section > .container-fluid > .row:nth-child(2) > div:last-child','visible')){
            if($('#apx_loading').attr('data-loading') == 'false' && apx_pages.length > 0){
                $('#apx_loading').attr('data-loading','true');
                $.get(apx_pages.shift(), function( data ) {
                    setTimeout(function(){ 
                        $(data).find('.order-1 > section > .container-fluid > .row:nth-child(2) > div').appendTo('.order-1 > section > .container-fluid > .row:nth-child(2)');
                        $('#apx_loading').attr('data-loading','false'); 
                        console.log('lista carregada');

                        $(function () {
                            var products = $('.product-card');
                            var modal_class = window.innerWidth < 768 ? 'modal--mobile' : '';
                            var loader = $('.product-buy-loader');
                    
                            modal_class += 'modal--product-buy';
                    
                            var hasAttrPers = function(data) {
                                var res = false;
                                var str = data;
                                var reg = new RegExp(/product-attribute|personalize-product/g);
                    
                                res = reg.test(str);
                    
                                return res;
                            };
                    
                            products.each(function() {                    
                                var card = $(this);
                                
                                var modal = card.find('.product-buy-modal');
                                var btn_buy = card.find('.product-buy-button');
                                var modal_content = modal.find('.product-action-content');
                                
                                if (!card.hasClass('kit')) {
                                    btn_buy.off('click').on('click', function(event) {
                                        var url = card.attr('data-product-url');
                                        var grid_id = card.attr('data-grid-id');
                                        var xhr = _dcs.Xhr(url);
                                        var product_name = card.attr('data-product-name');
                    
                                        if (modal.length == 0) {
                                            card.append('<div class="product-buy-modal" data-modal-title="' + product_name + '"><div class="product-action-content mt-5"></div></div>');
                                            
                                            modal = card.find('.product-buy-modal');
                                            modal_content = modal.find('.product-action-content'); 
                    
                                            // {# console.log(modal_content.length); #}
                                        }
                    
                                        event.preventDefault();
                                        event.stopPropagation();
                                        
                                        var quantity = card.find('.dc-quantity input[type="number"]').val() || 1;
                    
                                        if ($('.' + grid_id).length) {
                                            $('.' + grid_id).fadeIn();
                                            $('body').addClass('modal-open');
                                            $('body').css('overflow', 'hidden');
                                        } else {
                                            loader.fadeIn();
                    
                                            xhr.get({
                                                id: 'product-action',
                                                data: {
                                                    quantity: quantity
                                                }
                                            }).done(function(res) {
                                                modal_content.empty();
                                                modal_content.append(res);
                    
                                                console.log(res);
                    
                                                modal.modal({ class: modal_class + ' ' + grid_id });
                    
                                                if (!hasAttrPers(res)) {
                                                    $('.' + grid_id).find('#form-add-cart').submit();
                                                } else {
                                                    modal.open();
                                                    loader.fadeOut();
                                                }
                    
                                                var DOMContentLoaded_event = document.createEvent("Event");
                                                DOMContentLoaded_event.initEvent("DOMContentLoaded", true, true);
                                                window.document.dispatchEvent(DOMContentLoaded_event);
                    
                                                // {% if theme.settings.product_cart_add_redirect != 'not_redirect' %}
                                                //     loader.fadeOut();
                                                // {% endif %}
                                            });
                                        }
                                    });
                                } else {
                                    btn_buy.off('click').on('click', function(event) {
                                        event.preventDefault();
                                        event.stopPropagation();
                                        
                                        var url = card.attr('data-product-url');
                                        var grid_id = card.attr('data-grid-id');
                                        var xhr = _dcs.Xhr(url);
                    
                                        var quantity = card.find('.dc-quantity input[type="number"]').val() || 1;
                    
                                        loader.fadeIn();
                    
                                        xhr.get({
                                            id: 'collection-customize-buy',
                                            data: {
                                                quantity: quantity
                                            }
                                        }).done(function(res) {
                                            modal_content.empty();
                                            modal_content.append(res);
                                            modal.modal({ class: modal_class + ' ' + grid_id });
                    
                                            $('.' + grid_id).find('#form-add-cart-custom').submit();
                    
                                            var DOMContentLoaded_event = document.createEvent("Event");
                                            DOMContentLoaded_event.initEvent("DOMContentLoaded", true, true);
                                            window.document.dispatchEvent(DOMContentLoaded_event);
                    
                                            loader.fadeOut();
                                        });
                                    });
                                }
                            });
                        });

                        $(function() {
                            "use strict";
                            var d = function(e, t, a) {
                                t.val() && e.submit()
                            }
                              , e = function() {
                                var e = $("[dc-quantity]");
                                console.log(e),
                                0 < e.length && e.each(function() {
                                    var a = $(this).data()
                                      , n = $("[dc-quantity-input]", this)
                                      , e = $("[dc-quantity-decrease]", this)
                                      , t = $("[dc-quantity-increase]", this)
                                      , o = $("[dc-quantity-loader]", this)
                                      , r = $(this)
                                      , i = $(this).siblings("[dc-quantity-submit]")
                                      , c = n.val();
                                    a.max,
                                    a.min,
                                    Number(n.val());
                                    n.keyup(function(e) {
                                        var t = n.val();
                                        t && ((t = Number(t)) >= a.max ? n.val(a.max).change() : t <= a.min ? n.val(a.min).change() : n.val(t).change())
                                    }),
                                    n.blur(function(e) {
                                        n.val() != c && "event" == a.action && (o.show(),
                                        d(r, n, a))
                                    }),
                                    t.unbind("click"),
                                    t.bind("click", function(e) {
                                        !function(e, t, a, n) {
                                            e.preventDefault();
                                            var o = Number(t.val())
                                              , r = "";
                                            (o < a.max || !a.max) && (r = o + 1,
                                            t.val(r).change(),
                                            "event" == a.action && d(n, t, a))
                                        }(e, n, a, r)
                                    }),
                                    e.unbind("click"),
                                    e.bind("click", function(e) {
                                        !function(e, t, a, n) {
                                            e.preventDefault();
                                            var o = Number(t.val())
                                              , r = "";
                                            o > a.min && (r = o - 1,
                                            t.val(r).change(),
                                            "event" == a.action && d(n, t, a))
                                        }(e, n, a, r)
                                    }),
                                    i.unbind("click"),
                                    i.bind("click", function(e) {
                                        e.preventDefault(),
                                        d(r, n, a, o)
                                    }),
                                    r.on("submit", function(e) {
                                        o.show()
                                    })
                                })
                            };
                            e(),
                            $(document).ajaxComplete(function() {
                                e()
                            })
                        });
                    }, 1000);
                    
                });
            }else{
                if(apx_pages.length == 0 && $('#apx_loading-aviso').length == 0){
                    $('#apx_loading').hide();
                    $('<p id="apx_loading-aviso" class="my-5 text-center">Todos os produtos foram carregados.</p>').insertBefore('#apx_loading');
                    console.log('fim da lista');
                }
            }
        }
    }); 

    $('.collection-paginate-limit, .paginate').hide();
    $('.collection-paginate-sort').before('<label style="margin: 5px 10px 0 0;">Ordenar por: </label>')
}

function checkVisible( elm, evalType ) {
    //console.log(elm);
    evalType = evalType || "visible";

    var vpH = $(window).height(), // Viewport Height
        st = $(window).scrollTop(), // Scroll Top
        y = $(elm).offset().top,
        elementHeight = $(elm).height();

    if (evalType === "visible") return ((y < (vpH + st)) && (y > (st - elementHeight)));
    if (evalType === "above") return ((y < (vpH + st)));
}